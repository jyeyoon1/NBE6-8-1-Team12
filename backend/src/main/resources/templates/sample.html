<!doctype html>
<html lang="en">
<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-KyZXEAg3QhqLMpG8r+8fhAXLRk2vvoC2f3B09zVXn8CA5QIVfZOJ3BCsw2P0p/We" crossorigin="anonymous">

  <!-- 다음(카카오) 우편번호 및 주소 검색 API 스크립트 로드 -->
  <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

  <!-- 모달 스크립트 로드 -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    body {
        background: #ddd;
    }

    .card {
        margin: auto;
        max-width: 950px;
        width: 90%;
        box-shadow: 0 6px 20px 0 rgba(0, 0, 0, 0.19);
        border-radius: 1rem;
        border: transparent
    }

    .summary {
        background-color: #ddd;
        border-top-right-radius: 1rem;
        border-bottom-right-radius: 1rem;
        padding: 4vh;
        color: rgb(65, 65, 65)
    }

    @media (max-width: 767px) {
        .summary {
            border-top-right-radius: unset;
            border-bottom-left-radius: 1rem
        }
    }

    .row {
        margin: 0
    }

    .title b {
        font-size: 1.5rem
    }

    .col-2,
    .col {
        padding: 0 1vh
    }

    img {
        width: 3.5rem
    }

    hr {
        margin-top: 1.25rem
    }
    .products {
        width: 100%;
    }
    .products .price, .products .action {
        line-height: 38px;
    }
    .products .action {
        line-height: 38px;
    }

  </style>
  <title>팀 12 | 취급</title>
</head>
<body class="container-fluid">
<div class="row justify-content-center m-4">
  <h1 class="text-center">Grids & Circle</h1>
</div>
<div class="card">
  <div class="row">
    <div class="col-md-8 mt-4 d-flex flex-column align-items-start p-3 pt-0">
      <h5 class="flex-grow-0"><b>상품 목록</b></h5>
      <ul class="list-group products">
        <li class="list-group-item d-flex mt-3">
          <div class="col-2"><img class="img-fluid" src="https://i.imgur.com/HKOFQYa.jpeg" alt=""></div>
          <div class="col">
            <div class="row text-muted">커피콩</div>
            <div class="row">Columbia Nariñó</div>
          </div>
          <div class="col text-center price">5000원</div>
          <div class="col text-end action"><a class="btn btn-small btn-outline-dark" href="">추가</a></div>
        </li>
        <li class="list-group-item d-flex mt-2">
          <div class="col-2"><img class="img-fluid" src="https://i.imgur.com/HKOFQYa.jpeg" alt=""></div>
          <div class="col">
            <div class="row text-muted">커피콩</div>
            <div class="row">Columbia Nariñó</div>
          </div>
          <div class="col text-center price">5000원</div>
          <div class="col text-end action"><a class="btn btn-small btn-outline-dark" href="">추가</a></div>
        </li>
        <li class="list-group-item d-flex mt-2">
          <div class="col-2"><img class="img-fluid" src="https://i.imgur.com/HKOFQYa.jpeg" alt=""></div>
          <div class="col">
            <div class="row text-muted">커피콩</div>
            <div class="row">Columbia Nariñó</div>
          </div>
          <div class="col text-center price">5000원</div>
          <div class="col text-end action"><a class="btn btn-small btn-outline-dark" href="">추가</a></div>
        </li>
      </ul>
    </div>
    <div class="col-md-4 summary p-4">
      <div>
        <h5 class="m-0 p-0"><b>Summary</b></h5>
      </div>
      <hr>
      <div class="row">
        <h6 class="p-0">Columbia Nariñó <span class="badge bg-dark text-">2개</span></h6>
      </div>
      <div class="row">
        <h6 class="p-0">Brazil Serra Do Caparaó <span class="badge bg-dark">2개</span></h6>
      </div>
      <div class="row">
        <h6 class="p-0">Columbia Nariñó <span class="badge bg-dark">2개</span></h6>
      </div>
      <form>
        <div class="mb-3">
          <label for="email" class="form-label">이메일</label>
          <input type="email" class="form-control mb-1" id="email">
        </div>
        <div class="mb-3">
          <label for="address" class="form-label">배송지</label>
          <div class="input-group">
            <textarea class="form-control mb-1" id="address" rows="3" readonly></textarea>
            <button type="button" class="btn btn-secondary" onclick="execDaumPostcode()">주소 검색</button>
          </div>
        </div>

        <div class="mb-3">
          <label for="postcode" class="form-label">우편번호</label>
          <input type="text" class="form-control" id="postcode" readonly>
        </div>

        <div>당일 오후 2시 이후의 주문은 다음날 배송을 시작합니다.</div>
      </form>
      <div class="row pt-2 pb-2 border-top">
        <h5 class="col">총금액</h5>
        <h5 class="col text-end">15000원</h5>
      </div>
      <button class="btn btn-dark col-12">결제하기</button>
    </div>
  </div>
</div>
<script>

  // 선택된 구매 ID
  let selectedPurchaseId = null;

  // 다음 주소 API를 실행하여 우편번호와 주소를 입력받는 함수
  function execDaumPostcode() {
      new daum.Postcode({
          oncomplete: function(data) {
              let fullAddr = data.roadAddress ? data.roadAddress : data.jibunAddress;
              if (data.userSelectedType === 'R') {
                  let extraAddr = '';
                  if (data.bname) extraAddr += data.bname;
                  if (data.buildingName) extraAddr += (extraAddr ? ', ' + data.buildingName : data.buildingName);
                  if (extraAddr) fullAddr += ' (' + extraAddr + ')';
              }
              document.getElementById('postcode').value = data.zonecode;
              document.getElementById('address').value = fullAddr;
          }
      }).open();
  }

 // 이메일 입력창에서 포커스가 빠져나갈 때(blur 이벤트 발생)
 document.getElementById('email').addEventListener('blur', () => {
    const email = document.getElementById('email').value;
    if (!email) return; // 이메일이 없으면 종료

    // 서버에 최신 구매 내역 요청 (이메일로)
    fetch(`/api/shippings/latest-purchase/${email}`)
        .then(response => response.json())
        .then(purchase => {

            // 받아온 구매 정보의 id를 selectedPurchaseId에 저장
            selectedPurchaseId = purchase.id;
            console.log("최신 구매 ID:", selectedPurchaseId);
        });
  });

  // 결제하기 버튼 클릭 이벤트
  document.querySelector('.btn-dark').addEventListener('click', () => {

      // 구매 내역이 없는 경우(이메일 입력 안 함) 모달로 안내하고 결제 중단
      if (!selectedPurchaseId) {
        showInfoModal("이메일을 입력하여 구매 내역을 불러와야 합니다.");
        return;
      }

      // 입력한 주소와 우편번호 가져오기
      const address = document.getElementById('address').value;
      const postcode = document.getElementById('postcode').value;

      // 서버에 배송 정보 등록 API 호출
      fetch('/api/shippings', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
              purchaseId: selectedPurchaseId,
              address: address,
              postcode: postcode,
              status: 'DELIVERING'
          })
      })
      .then(response => {
          if (response.ok) {
              showInfoModal('배송지가 저장되었습니다!');
              return response.json();
          } else {
              showInfoModal('배송 저장 실패!!');
          }
      })
      .catch(error => {
          console.error('배송 저장 중 에러 발생:', error);
          showInfoModal('배송 저장 중 오류가 발생했습니다.');
      });
  });

  // 안내 메시지를 모달로 보여주는 함수
  function showInfoModal(message) {
    document.getElementById('infoModalMessage').textContent = message;
    let modal = new bootstrap.Modal(document.getElementById('infoModal'));
    modal.show();
  }

</script>

<!-- 안내 메시지를 보여줄 Bootstrap 모달 -->
<div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="infoModalLabel">안내</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="infoModalMessage"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
      </div>
    </div>
  </div>
</div>
</body>
</html>